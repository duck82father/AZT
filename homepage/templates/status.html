{% extends 'base.html' %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css"/>
<div class="nav-background-behind"></div>
<div class="container-fruid whole_wrap">
    <div class="row">

        <div class="col-7 quiz_wrap">
            <div class="d-flex flex-wrap justify-content-center align-items-start m-3 p-3">
                {% for quiz in quizs %}
                    <div class="my-2">
                        <div class="col-10 card m-3" style="width: 14rem; height: 11rem; border-radius: 0.6rem" id="quizbox{{ quiz.id }}">
                                <div class="card-body text-quiz">
                                    <h5 class="card-title fs-5 text fw-bold lh-base" style="word-break: keep-all" id="quiz{{ quiz.id }}">{{ quiz.quiz }}</h5>
                                    <p class="card-text"></p>
                                </div>
                                {% if solved.user_id == g.user.id and solved.quiz_id == quiz.id %}
                                    <div class="container card-footer quizsuccess">
                                        <div class="row">
                                            <span class="col-5 p-2 fw-bold text-white-50 fs-6">No. {{ quiz.id }}</span>
                                            <span class="col-7 fw-bold text-light text-end p-2">
                                                {{ quiz.answer }}
                                {% else %}
                                    <div class="container card-footer">
                                        <div class="row">
                                            <span class="col-5 p-2 fs-6">No. {{ quiz.id }}</span>        
                                            <span class="col-7 text-black-50 text-end p-2">
                                                ÎèÑÏ†Ñ Í∞ÄÎä•                                            
                                {% endif %}
                                            </span>
                                        </div>
                                </div>
                        </div>
                    </div>
                {% endfor %}
              </div>
        </div>
        
        <div class="col-5">
            
            <div class="chat_wrap">
                <div class="inner">
                    <!-- ÎåÄÌôî ÏïÑÏù¥ÌÖúÏù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê† Í≥µÍ∞Ñ -->
                </div>
                
                <input type="text" class="mymsg h5 p-4 chatbotinput" placeholder="ÎÇ¥Ïö© ÏûÖÎ†• ÌõÑ ÏóîÌÑ∞Î•º ÎàÑÎ•¥ÏÑ∏Ïöî">

                <div class="text-center">
                    <br>
                    <p>Î¨∏Ï†úÎ•º ÌíÄÍ≥† Ïã∂Îã§Î©¥ <b class="fw-bold">'Î¨∏Ï†úÎ≤àÌò∏(1~120Î≤à)'</b>Î•º, <b class="fw-bold">'ÏïàÎÇ¥'</b>Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî üëç</p>
                </div>
                <script>   
                
                    // ÌéòÏù¥ÏßÄ Î°úÎìú ÌõÑ Ïã§ÌñâÎêòÎäî Ìï®Ïàò
                    document.addEventListener("DOMContentLoaded", function() {
                        var mymsgInput = document.querySelector('.mymsg');
                        var yourmsgInput = document.querySelector('.yourmsg');
                        var chatInner = document.querySelector('.chat_wrap .inner');
                        var elementBoxGlobal = null
                        var elementTextGlobal = null
                        var quiznumber = 0

                        // XMLHttpRequest Í∞ùÏ≤¥ ÏÉùÏÑ±
                        var xhr = new XMLHttpRequest();                 

                        mymsgInput.addEventListener('keypress', function(e) {

                            if (e.keyCode === 13 && this.value.length && quiznumber > 0) {
                                sendMessage(this.value, 'mymsg');                                
                                
                                xhr.open('POST', 'api/endpoint', true);                    // ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇº Î©îÏÑúÎìú Î∞è URL ÏÑ§Ï†ï
                                xhr.setRequestHeader('Content-Type', 'application/json');   // Content-Type Ìó§Îçî ÏÑ§Ï†ï (JSON Ï†ÑÏÜ° ÏãúÏóêÎäî ÌïÑÏöî)                             
                                xhr.onload = function() {                                   // ÏöîÏ≤≠ ÏôÑÎ£å ÏãúÏùò ÏΩúÎ∞± Ìï®Ïàò ÏÑ§Ï†ï
                                                                       
                                    if (xhr.status === 200) {
                                        var result = JSON.parse(xhr.responseText).result;
                                        var resulttype = JSON.parse(xhr.responseText).resulttype;
                                        if (resulttype == 'quiz') {
                                            clearCheckBox()
                                            sendMessageQuiz(result, 'yourmsg');
                                            toScrollMoving(result);
                                        } else if (resulttype == 'answer') {
                                            sendMessage(result, 'yourmsg');
                                            quiznumber = 0
                                        } else {
                                            sendMessage(result, 'yourmsg');
                                        };

                                    } else {
                                        console.error('Request failed. Status:', xhr.status);
                                    }
                                };
                                var data = { key: this.value, quiznumber: quiznumber };            // Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞                                
                                xhr.send(JSON.stringify(data));         // Îç∞Ïù¥ÌÑ∞Î•º JSON Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌïòÏó¨ Ï†ÑÏÜ°

                                this.value = '';
                            }
                            else if (e.keyCode === 13 && this.value.length) {
                                sendMessage(this.value, 'mymsg');                                

                                xhr.open('POST', 'api/endpoint', true);                    // ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇº Î©îÏÑúÎìú Î∞è URL ÏÑ§Ï†ï
                                xhr.setRequestHeader('Content-Type', 'application/json');   // Content-Type Ìó§Îçî ÏÑ§Ï†ï (JSON Ï†ÑÏÜ° ÏãúÏóêÎäî ÌïÑÏöî)                             
                                xhr.onload = function() {                                   // ÏöîÏ≤≠ ÏôÑÎ£å ÏãúÏùò ÏΩúÎ∞± Ìï®Ïàò ÏÑ§Ï†ï

                                    if (xhr.status === 200) {
                                        var result = JSON.parse(xhr.responseText).result;
                                        var resulttype = JSON.parse(xhr.responseText).resulttype;
                                        if (resulttype == 'quiz') {
                                            clearCheckBox()
                                            sendMessageQuiz(result, 'yourmsg');
                                            toScrollMoving(result);
                                        } else {
                                            sendMessage(result, 'yourmsg');
                                        };
                                    } else {
                                        console.error('Request failed. Status:', xhr.status);
                                    }
                                };
                                var data = { key: this.value, quiznumber: quiznumber };            // Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞                                
                                xhr.send(JSON.stringify(data));         // Îç∞Ïù¥ÌÑ∞Î•º JSON Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌïòÏó¨ Ï†ÑÏÜ°

                                this.value = '';
                            }});
                    

                        var currentTime = function(){
                            var date = new Date();
                            var hh = date.getHours();
                            var mm = date.getMinutes();
                            var apm = hh > 12 ? "Ïò§ÌõÑ" : "Ïò§Ï†Ñ";
                            var ct = apm + " " + hh + ":" + mm + "";
                            return ct;
                        };
        
                        function sendMessage(message, className) {
                            var newDiv = document.createElement('div');
                            newDiv.className = 'item ' + className;
                            newDiv.innerHTML = '<div class="box"><p class="msg h6">' + message + '</p><span class="time">' + currentTime() + '</span></div>';
                        
                            chatInner.appendChild(newDiv);
        
                            var lastItem = chatInner.lastChild;
                            setTimeout(function(){
                                lastItem.classList.add("on");
                            }, 10);
        
                            var position = lastItem.offsetTop + chatInner.scrollTop;
                            chatInner.scrollTop = position;
                        }

                        function sendMessageQuiz(result, className) {
                            var newDiv = document.createElement('div');
                            newDiv.className = 'item ' + className;
                            const message = document.getElementById('quiz'+result).innerHTML;
                            newDiv.innerHTML = '<div class="box"><p class="msg h6"><b class="fw-bold">Q. ' + message + '</b></p><span class="time">' + currentTime() + '</span></div>';

                            chatInner.appendChild(newDiv);
        
                            var lastItem = chatInner.lastChild;
                            setTimeout(function(){
                                lastItem.classList.add("on");
                            }, 10);
        
                            var position = lastItem.offsetTop + chatInner.scrollTop;
                            chatInner.scrollTop = position;
                        }

                        function clearCheckBox() {
                            if (elementBoxGlobal) {
                                    elementBoxGlobal.setAttribute('class', 'col-10 card m-3')
                                    elementTextGlobal.setAttribute('style', 'word-break:keep-all;')
                                }
                        }
                        
                        function toScrollMoving(result) {
                            quiznumber = result
                            elementBox = document.querySelector('#quizbox'+result);
                            elementText = document.querySelector('#quiz'+result);
                            if (elementBox) {
                                elementBox.scrollIntoView({ behavior: 'smooth', block: "center", inline: "center" });
                                elementBox.setAttribute('class', 'col-10 card m-3 selected_quiz')
                                elementText.setAttribute('style', 'word-break:keep-all; color:#916e07;')
                            }
                            elementBoxGlobal = elementBox
                            elementTextGlobal = elementText
                        }                        

                        sendMessage('<b class="fw-bold">{{ g.user.username }}</b>Îãò ÌôòÏòÅÌï©ÎãàÎã§!','yourmsg')

                        function information(){
                            sendMessage('<b class="fw-bold">ÏïÑÏû¨ÌÄ¥Ï¶à Î¨∏Ï†ú</b>Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî<br>[ ÏûÖÎ†• : 1 ~ 120Î≤à ]','yourmsg')
                            sendMessage('<b class="fw-bold">Tip</b> : Î∞∞Í≥†ÌîåÎïê ÏùåÏãùÏùÑ <b class="fw-bold text-danger">"Ï£ºÎ¨∏"</b>Ìï¥Î≥¥ÏÑ∏Ïöîüçú','yourmsg')
                        }
                        information()
                    });


                    // ÌôîÎ©¥ Ïä§ÌÅ¨Î°§ Ïãú navbar ÏÇ¨ÎùºÏßê Î∞©ÏßÄ
                    
                    let yOffset = 0;
                    
                    const navGlobalFixed = () => {
                    if (yOffset > 50) {
                        document.body.classList.add("local-nav-sticky");
                    } else {
                        document.body.classList.remove("local-nav-sticky");
                    }
                    };


                </script>
            </div>

        </div>
    </div>
</div>

{% endblock %}
